services:
  # --- Serviço do Redis ---
  redis:
    image: "redis:alpine"
    container_name: redis-cache
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - ./redis-data:/data
    restart: always

  # --- Serviço do SQL Server ---
  sql-server-db:
    image: "mcr.microsoft.com/mssql/server:2022-latest"
    environment:
      - ACCEPT_EULA=Y
      - SA_USERNAME=sa
      - SA_PASSWORD=Opala@1704.Test!
    ports:
      - "1433:1433"
    volumes:
      - sql-server-data:/var/opt/mssql
    healthcheck:
      test: ["CMD", "/opt/mssql-tools18/bin/sqlcmd", "-S", "127.0.0.1,1433", "-U", "sa", "-P", "Opala@1704.Test!", "-Q", "SELECT 1", "-C"]   
      interval: 20s
      timeout: 15s
      retries: 10
      start_period: 120s

  # --- NOVO: Serviço do MongoDB ---
  mongo-db:
    image: mongo:latest
    container_name: mongo-db
    restart: always
    ports:
      - "27017:27017" # Porta padrão do Mongo
    volumes:
      - mongo-data:/data/db # Volume para persistir os dados
    # Se quiser autenticação (opcional para dev local), descomente as linhas abaixo:
    # environment:
    #   MONGO_INITDB_ROOT_USERNAME: admin
    #   MONGO_INITDB_ROOT_PASSWORD: password123

  # --- Serviço da sua Aplicação Web ---
  webapp:
    container_name: backend-api
    build: 
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "5045:5045"
    env_file:
      - .env
    environment:
      - ASPNETCORE_URLS=http://+:8080
      # --- Configurações de Banco de Dados ---
      - ConnectionStrings__DefaultConnection=${ConnectionStrings__DefaultConnection}
      # AQUI: A string de conexão aponta para o nome do container "mongo-db"
      - ConnectionStrings__MongoConnection=mongodb://mongo-db:27017
      - ConnectionStrings__Redis=${ConnectionStrings__Redis}
      # --- Configurações Externas ---
      - MercadoPago__AccessToken=${MercadoPago__AccessToken}
      - MercadoPago__WebhookSecret=${MercadoPago__WebhookSecret}
      - MercadoPago__PublicKey=${MercadoPago__PublicKey}
      - Jwt__Key=${Jwt__Key}
      - Google__ClientId=${Google__ClientId}
      - Google__ClientSecret=${Google__ClientSecret}
      - SendGrid__ApiKey=${SendGrid__ApiKey}
      - SendGrid__FromEmail=${SendGrid__FromEmail}
      - SendGrid__FromName=${SendGrid__FromName}
      - General__BaseUrl=${GENERAL_BASEURL}
      - USE_REDIS=${USE_REDIS}
    depends_on:
      redis:
        condition: service_started
      sql-server-db:
        condition: service_healthy
      # O backend agora espera o Mongo iniciar também
      mongo-db:
        condition: service_started
    volumes:
      - ./uploads:/app/wwwroot/uploads
      - ./logs:/app/logs    

  # --- Frontend (React + Vite) ---
  frontend:
    container_name: frontend-react
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_GENERAL_BASEURL=${GENERAL_BASEURL} 
    ports:
      - "5173:80"
    depends_on:
      - webapp      

# --- Definição dos Volumes ---
volumes:
  sql-server-data:
  mongo-data: # Volume criado para o Mongo